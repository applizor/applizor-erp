// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTICATION & AUTHORIZATION
// ============================================

model User {
  id               String    @id @default(uuid())
  email            String    @unique
  password         String
  firstName        String
  lastName         String
  phone            String?
  isActive         Boolean   @default(true)
  lastLogin        DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  resetToken       String?
  resetTokenExpiry DateTime?

  // Relations
  companyId          String?
  company            Company?    @relation(fields: [companyId], references: [id])
  roles              UserRole[]
  auditLogs          AuditLog[]
  createdTasks       Task[]      @relation("TaskCreator")
  assignedTasks      Task[]      @relation("TaskAssignee")
  employee           Employee?
  createdEmployees   Employee[]  @relation("EmployeeCreator")
  assignedLeads      Lead[]      @relation("LeadAssignee")
  createdLeads       Lead[]      @relation("LeadCreator")
  assignedQuotations Quotation[] @relation("QuotationAssignee")
  createdQuotations  Quotation[] @relation("QuotationCreator")
  createdContracts   Contract[]  @relation("ContractCreator")
  createdClients     Client[]    @relation("ClientCreator")
  projectNotes       ProjectNote[]
  taskComments       TaskComment[]
  watchedTasks       TaskWatcher[]
  taskHistory        TaskHistory[]
  notifications      Notification[]

  @@index([email])
  @@index([companyId])
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  userRoles   UserRole[]
  permissions RolePermission[]

  @@index([name])
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

// RolePermission now stores the Matrix values directly
model RolePermission {
  id     String @id @default(uuid())
  roleId String
  module String // e.g. "Assets", "Payroll", "Employees"

  // Access Levels: "none", "all", "added", "owned", "both"
  createLevel String @default("none")
  readLevel   String @default("none")
  updateLevel String @default("none")
  deleteLevel String @default("none")

  createdAt DateTime @default(now())

  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, module])
  @@index([roleId])
}

// ============================================
// COMPANY & ORGANIZATION
// ============================================

model Company {
  id            String  @id @default(uuid())
  name          String
  legalName     String?
  email         String?
  phone         String?
  address       String?
  city          String?
  state         String?
  country       String  @default("India")
  currency      String  @default("USD") // USD, INR
  pincode       String?
  gstin         String?
  pan           String?
  tan           String?
  logo          String?
  digitalSignature String? // Global company signature
  letterheadDoc String? // Path to letterhead DOCX template
  letterhead    String? // First page background image
  continuationSheet String? // Subsequent pages background image
  pdfMarginTop  Int     @default(180)
  pdfMarginBottom Int   @default(80)
  pdfMarginLeft Int     @default(40)
  pdfMarginRight Int    @default(40)
  pdfContinuationTop Int @default(80)

  // Attendance Settings
  allowedIPs String? // Comma separated IPs
  latitude   Float?
  longitude  Float?
  radius     Int     @default(100) // in meters

  isActive       Boolean  @default(true)
  enabledModules Json? // ["HRMS", "CRM", "PAYROLL", "PROJECTS"]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  users              User[]
  clients            Client[]
  leads              Lead[]
  projects           Project[]
  employees          Employee[]
  departments        Department[]
  invoices           Invoice[]
  documents          Document[]
  subscriptions      Subscription[]
  shifts             Shift[]
  assets             Asset[]
  jobOpenings        JobOpening[]
  candidates         Candidate[]
  auditLogs          AuditLog[]
  emailTemplates     EmailTemplate[]
  salaryComponents   SalaryComponent[]
  salesTargets       SalesTarget[]
  branches           Branch[]
  accounts           LedgerAccount[]
  journalEntries     JournalEntry[]
  documentTemplates  DocumentTemplate[]
  quotations         Quotation[]
  quotationTemplates QuotationTemplate[]
  contracts          Contract[]
  contractTemplates  ContractTemplate[]
  clientCategories   ClientCategory[]
  taxRates           TaxRate[]
  unitTypes          UnitType[]

  @@index([name])
}

model Branch {
  id        String   @id @default(uuid())
  companyId String
  name      String
  code      String?
  address   String?
  city      String?
  state     String?
  country   String   @default("India")
  pincode   String?
  phone     String?
  email     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, code])
  @@index([companyId])
}

// ============================================
// CRM & SALES
// ============================================

model Client {
  id             String    @id @default(uuid())
  companyId      String
  name           String
  companyName    String?
  email          String?
  phone          String?
  address        String?
  city           String?
  state          String?
  country        String    @default("India")
  pincode        String?
  gstin          String?
  pan            String?
  salutation     String?
  gender         String?
  language       String?   @default("English")
  profilePicture String?
  mobile         String?
  website        String?
  taxName        String?
  shippingAddress String?  @db.Text
  notes          String?   @db.Text
  companyLogo    String?
  receiveNotifications Boolean @default(true)

  status         String    @default("active") // active, inactive, blocked
  clientType     String    @default("customer") // customer, prospect, lead
  currency       String    @default("INR")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  company        Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdById    String?
  creator        User?     @relation("ClientCreator", fields: [createdById], references: [id])
  
  categoryId     String?
  category       ClientCategory? @relation(fields: [categoryId], references: [id])
  subCategoryId  String?
  subCategory    ClientSubCategory? @relation(fields: [subCategoryId], references: [id])

  projects       Project[]
  invoices       Invoice[]
  subscriptions  Subscription[]
  documents      Document[]
  contracts      Contract[]
  quotations     Quotation[]

  createdTasks   Task[]    @relation("ClientTaskCreator")
  taskComments   TaskComment[]
  taskHistory    TaskHistory[]
  
  // Portal Access
  password       String?   // Hashed password
  portalAccess   Boolean   @default(false)
  lastLogin      DateTime?

  @@index([companyId])
  @@index([email])
  @@index([status])
  @@index([categoryId])
}

model ClientCategory {
  id        String   @id @default(uuid())
  companyId String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company      Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  clients      Client[]
  subCategories ClientSubCategory[]

  @@index([companyId])
}

model ClientSubCategory {
  id         String   @id @default(uuid())
  categoryId String
  name       String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  category ClientCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  clients  Client[]

  @@index([categoryId])
}

model Lead {
  id        String  @id @default(uuid())
  companyId String
  name      String
  email     String?
  phone     String?
  company   String?

  // Enhanced Fields
  jobTitle String?
  website  String?
  industry String?

  // Lead Source
  source        String? // website, referral, cold-call, linkedin, etc.
  sourceDetails String? // Specific campaign, referrer name, etc.

  // Sales Pipeline
  status String @default("new") // new, contacted, qualified, proposal, negotiation, won, lost
  stage  String @default("lead") // lead, contacted, qualified, proposal, negotiation, closed

  // Value & Priority
  value       Decimal? @db.Decimal(12, 2)
  currency    String   @default("INR")
  probability Int      @default(0) // 0-100%
  priority    String   @default("medium") // low, medium, high, urgent

  // Assignment
  assignedTo String?
  assignedAt DateTime?

  // Creator Tracking (for permissions)
  createdBy String?

  // Tracking
  lastContactedAt DateTime?
  nextFollowUpAt  DateTime?

  // Conversion
  convertedToClientId String?
  convertedAt         DateTime?

  // Notes & Tags
  notes String?  @db.Text
  tags  String[] @default([])

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  companyRel   Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  assignedUser User?          @relation("LeadAssignee", fields: [assignedTo], references: [id])
  creator      User?          @relation("LeadCreator", fields: [createdBy], references: [id])
  activities   LeadActivity[]
  quotations   Quotation[]

  @@index([companyId])
  @@index([status])
  @@index([stage])
  @@index([assignedTo])
  @@index([createdBy])
  @@index([nextFollowUpAt])
}

// Lead Activity Tracking
model LeadActivity {
  id          String  @id @default(uuid())
  leadId      String
  type        String // call, email, meeting, note, status_change, follow_up
  title       String
  description String? @db.Text

  // Follow-up Specific
  outcome     String? // successful, unsuccessful, no_answer, rescheduled, completed
  scheduledAt DateTime? // When follow-up is scheduled
  completedAt DateTime? // When follow-up was completed
  dueDate     DateTime? // Follow-up due date

  // Reminder Settings
  reminderSent Boolean   @default(false)
  reminderTime DateTime? // When to send reminder

  // Assignment
  assignedTo String? // User ID
  createdBy  String

  // Status
  status String @default("pending") // pending, completed, cancelled, overdue

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([type])
  @@index([scheduledAt])
  @@index([status])
  @@index([assignedTo])
  @@index([dueDate])
}

// Quotations/Proposals
model Quotation {
  id        String  @id @default(uuid())
  companyId String
  leadId    String?
  clientId  String?

  quotationNumber String  @unique
  title           String
  description     String? @db.Text

  // Dates
  quotationDate DateTime @db.Date
  validUntil    DateTime @db.Date

  // Status
  status String @default("draft") // draft, sent, accepted, rejected, expired

  // Amounts
  subtotal Decimal @db.Decimal(12, 2)
  tax      Decimal @default(0) @db.Decimal(12, 2)
  discount Decimal @default(0) @db.Decimal(12, 2)
  total    Decimal @db.Decimal(12, 2)
  currency String  @default("INR") // Currency at time of creation (INR, USD, etc.)

  // Terms
  paymentTerms  String? @db.Text
  deliveryTerms String? @db.Text
  notes         String? @db.Text

  // Document
  pdfPath    String?
  templateId String?

  // Public Sharing
  publicToken     String?   @unique
  publicExpiresAt DateTime?
  isPublicEnabled Boolean   @default(false)

  // Client Acceptance
  clientViewedAt   DateTime?
  clientAcceptedAt DateTime?
  clientRejectedAt DateTime?
  clientSignature  String?   @db.Text // Base64 signature image
  clientEmail      String?
  clientName       String?
  clientComments   String?   @db.Text
  signedPdfPath    String?

  // Conversion
  convertedToInvoiceId String?
  convertedAt          DateTime?

  // Creator Tracking (for permissions)
  createdBy  String?
  assignedTo String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lead         Lead?   @relation(fields: [leadId], references: [id])
  client       Client? @relation(fields: [clientId], references: [id])
  company      Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator      User?   @relation("QuotationCreator", fields: [createdBy], references: [id])
  assignedUser User?   @relation("QuotationAssignee", fields: [assignedTo], references: [id])

  items      QuotationItem[]
  activities QuotationActivity[]

  // Analytics
  viewCount         Int       @default(0)
  lastViewedAt      DateTime?
  emailOpens        Int       @default(0)
  lastEmailOpenedAt DateTime?

  // Auto-Reminders
  reminderFrequency String? // DAILY, WEEKLY, CUSTOM
  nextReminderAt    DateTime?
  reminderCount     Int       @default(0)
  maxReminders      Int       @default(3)

  @@unique([companyId, quotationNumber])
  @@index([companyId])
  @@index([leadId])
  @@index([clientId])
  @@index([status])
}

model QuotationItem {
  id          String  @id @default(uuid())
  quotationId String
  description String
  quantity    Decimal @db.Decimal(10, 2)
  unit        String?
  unitPrice   Decimal @db.Decimal(12, 2)
  tax         Decimal @default(0) @db.Decimal(5, 2)
  taxRateId   String?
  discount    Decimal @default(0) @db.Decimal(5, 2)
  total       Decimal @db.Decimal(12, 2)

  quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  taxRateConfig TaxRate? @relation(fields: [taxRateId], references: [id])

  appliedTaxes QuotationItemTax[]

  @@index([quotationId])
  @@index([taxRateId])
}

// Analytics & Activity Log
model QuotationActivity {
  id          String @id @default(uuid())
  quotationId String
  type        String // VIEWED, DOWNLOADED, EMAIL_OPENED, LINK_CLICKED, STATUS_CHANGE

  // Detailed Tracking
  ipAddress  String?
  userAgent  String?
  location   String?
  deviceType String? // Mobile, Desktop, Tablet
  browser    String?
  os         String?

  // Metadata
  metadata  Json? // Any extra data
  createdAt DateTime @default(now())

  quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)

  @@index([quotationId])
  @@index([type])
  @@index([createdAt])
}

// Quotation Templates
model QuotationTemplate {
  id        String @id @default(uuid())
  companyId String

  name        String
  description String? @db.Text
  category    String? // e.g., "Web Development", "Consulting", "Design"

  // Template Content
  title               String
  templateDescription String  @db.Text
  paymentTerms        String? @db.Text
  deliveryTerms       String? @db.Text
  notes               String? @db.Text

  // Template Items (stored as JSON)
  items Json // Array of {description, quantity, unitPrice, tax, discount}

  // Metadata
  isActive   Boolean @default(true)
  usageCount Int     @default(0)

  // Creator Tracking
  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([category])
  @@map("quotation_templates")
}

// Quick Estimates
model Estimate {
  id          String  @id @default(uuid())
  companyId   String
  leadId      String?
  title       String
  description String? @db.Text

  // Quick Estimate
  estimatedValue Decimal @db.Decimal(12, 2)
  timeframe      String? // "2-3 weeks", "1 month", etc.

  // Status
  status String @default("draft") // draft, shared, accepted, rejected

  // Conversion
  convertedToQuotationId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([leadId])
}

// ============================================
// PROJECTS & TASKS
// ============================================

model Project {
  id          String    @id @default(uuid())
  companyId   String
  clientId    String?
  name        String
  description String?   @db.Text
  status      String    @default("planning") // planning, active, on-hold, completed, cancelled
  startDate   DateTime?
  endDate     DateTime?
  budget      Decimal?  @db.Decimal(12, 2)
  actualRevenue  Decimal?  @db.Decimal(12, 2)
  actualExpenses Decimal?  @db.Decimal(12, 2)
  isBillable  Boolean   @default(true)
  tags        String[]  @default([])
  priority    String    @default("medium") // low, medium, high, urgent
  currency    String    @default("INR") // USD, INR
  settings    Json?     // Stores project-specific configuration (permissions matrix, etc.)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  company    Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client     Client?     @relation(fields: [clientId], references: [id])
  tasks      Task[]
  members    ProjectMember[]
  milestones Milestone[]
  notes      ProjectNote[]
  timesheets Timesheet[]
  documents  Document[]
  invoices   Invoice[]
  contracts  Contract[]
  sprints    Sprint[]
  automationRules AutomationRule[]
  activeTimers    ActiveTimer[]

  @@index([companyId])
  @@index([clientId])
  @@index([status])
}

// ... existing code ...

model AutomationRule {
  id          String   @id @default(uuid())
  projectId   String
  name        String
  triggerType String   // 'TASK_STATUS_CHANGE', 'TASK_CREATED'
  triggerConfig Json   // e.g. { from: '*', to: 'done' }
  actionType  String   // 'SEND_EMAIL'
  actionConfig Json    // e.g. { recipient: 'client', subject: '...', body: '...' }
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model Task {
  id           String    @id @default(uuid())
  projectId    String
  title        String
  description  String?   @db.Text
  status       String    @default("todo")
  type         String    @default("task") // epic, story, task, bug, subtask
  priority     String    @default("medium")
  tags         String[]  @default([])
  
  // Advanced Agile/Jira fields
  storyPoints  Int?      @default(0)
  startDate    DateTime?
  dueDate      DateTime?
  position     Float     @default(0) // For board/backlog ordering

  // Creator can be User OR Client
  createdById    String?
  createdClientId String?

  assignedToId String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  milestoneId  String?
  sprintId     String?
  
  // Hierarchy
  parentId     String?
  epicId       String?

  // Relations
  project      Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator      User?      @relation("TaskCreator", fields: [createdById], references: [id])
  clientCreator Client?   @relation("ClientTaskCreator", fields: [createdClientId], references: [id])
  
  assignee     User?      @relation("TaskAssignee", fields: [assignedToId], references: [id])
  milestone    Milestone? @relation(fields: [milestoneId], references: [id])
  sprint       Sprint?    @relation(fields: [sprintId], references: [id])
  
  // Hierarchy Relations
  parent       Task?      @relation("SubTasks", fields: [parentId], references: [id], onDelete: SetNull)
  subtasks     Task[]     @relation("SubTasks")
  epic         Task?      @relation("EpicTasks", fields: [epicId], references: [id], onDelete: SetNull)
  tasksInEpic  Task[]     @relation("EpicTasks")

  comments     TaskComment[]
  documents    Document[]
  watchers     TaskWatcher[]
  linksAsSource TaskLink[] @relation("SourceTask")
  linksAsTarget TaskLink[] @relation("TargetTask")
  history       TaskHistory[]
  timesheets    Timesheet[]
  activeTimers  ActiveTimer[]

  @@index([projectId])
  @@index([status])
  @@index([assignedToId])
  @@index([milestoneId])
  @@index([sprintId])
  @@index([parentId])
  @@index([epicId])
  @@index([type])
  @@index([createdById])
  @@index([createdClientId])
}

model TaskComment {
  id        String   @id @default(uuid())
  taskId    String
  content   String   @db.Text
  
  // Commenter can be User OR Client
  userId    String?
  clientId  String?

  parentId  String?
  parent    TaskComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   TaskComment[] @relation("CommentReplies")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task    Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user    User?  @relation(fields: [userId], references: [id])
  client  Client? @relation(fields: [clientId], references: [id])

  @@index([taskId])
  @@index([userId])
  @@index([clientId])
  @@index([parentId])
}

model TaskHistory {
  id        String   @id @default(uuid())
  taskId    String
  userId    String?
  clientId  String?
  field     String   // e.g., 'status', 'priority'
  oldValue  String?
  newValue  String?
  createdAt DateTime @default(now())

  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])
  client    Client?  @relation(fields: [clientId], references: [id])

  @@index([taskId])
}

model ActiveTimer {
  // ... existing fields ...
  id          String   @id @default(uuid())
  companyId   String
  employeeId  String   @unique
  projectId   String
  taskId      String?
  startTime   DateTime @default(now())
  
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task        Task?    @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@index([employeeId])
  @@map("active_timers")
}

model Notification {
  id          String   @id @default(uuid())
  companyId   String
  userId      String   // Target user
  title       String
  message     String
  type        String   @default("info") // info, success, warning, error, task_update, task_assigned
  isRead      Boolean  @default(false)
  link        String?  // Optional link to redirect
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([companyId])
  @@map("notifications")
}

model Sprint {
  id          String    @id @default(uuid())
  projectId   String
  name        String
  goal        String?   @db.Text
  startDate   DateTime?
  endDate     DateTime?
  status      String    @default("future") // future, active, completed
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks       Task[]

  @@index([projectId])
  @@index([status])
}

model TaskWatcher {
  id        String   @id @default(uuid())
  taskId    String
  userId    String
  createdAt DateTime @default(now())

  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
}

model TaskLink {
  id           String   @id @default(uuid())
  sourceId     String
  targetId     String
  relationType String   @default("relates_to") // blocks, blocked_by, duplicates, relates_to
  createdAt    DateTime @default(now())

  sourceTask   Task     @relation("SourceTask", fields: [sourceId], references: [id], onDelete: Cascade)
  targetTask   Task     @relation("TargetTask", fields: [targetId], references: [id], onDelete: Cascade)

  @@index([sourceId])
  @@index([targetId])
}



model ProjectMember {
  id         String   @id @default(uuid())
  projectId  String
  employeeId String
  role       String   @default("member") // manager, developer, designer, observer
  joinedAt   DateTime @default(now())

  project  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([projectId, employeeId])
  @@index([projectId])
  @@index([employeeId])
}

model Milestone {
  id          String    @id @default(uuid())
  projectId   String
  title       String
  description String?   @db.Text
  dueDate     DateTime?
  amount      Decimal?  @db.Decimal(12, 2)
  currency    String    @default("INR")
  status      String    @default("pending") // pending, completed, overdue
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   Task[]

  @@index([projectId])
}

model ProjectNote {
  id        String   @id @default(uuid())
  projectId String
  title     String
  content   String   @db.Text
  isPinned  Boolean  @default(false)
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator User    @relation(fields: [createdBy], references: [id])

  @@index([projectId])
}

// ============================================
// TIMESHEETS & UTILIZATION
// ============================================

model Timesheet {
  id          String   @id @default(uuid())
  companyId   String
  projectId   String?
  employeeId  String
  date        DateTime @db.Date
  hours       Decimal  @db.Decimal(5, 2)
  isBillable  Boolean  @default(true)
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  taskId      String?
  startTime   DateTime? // For timer-based logging
  endTime     DateTime?

  // Relations
  project  Project? @relation(fields: [projectId], references: [id])
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  task     Task?    @relation(fields: [taskId], references: [id])

  // Removed unique constraint to allow multiple entries per day
  @@index([companyId])
  @@index([employeeId])
  @@index([projectId])
  @@index([taskId])
  @@index([date])
}

// ============================================
// HRMS
// ============================================

model Department {
  id          String   @id @default(uuid())
  companyId   String
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  company   Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employees Employee[]
  positions Position[]

  @@unique([companyId, name])
  @@index([companyId])
}

model Position {
  id           String   @id @default(uuid())
  departmentId String
  title        String
  description  String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  employees  Employee[]

  @@unique([departmentId, title])
  @@index([departmentId])
}

model Employee {
  id         String  @id @default(uuid())
  companyId  String
  userId     String? @unique
  employeeId String // Employee ID/Code
  firstName  String
  lastName   String
  email      String  @unique
  phone      String?

  // Personal Info
  gender        String? // Male, Female, Other
  bloodGroup    String?
  maritalStatus String? // Single, Married

  // Dates
  dateOfBirth   DateTime?
  dateOfJoining DateTime

  // Addresses
  currentAddress   String? @db.Text
  permanentAddress String? @db.Text

  // Emergency Contact
  emergencyContact Json? // { name: "...", relation: "...", phone: "..." }

  // Bank & Statutory
  bankName      String?
  accountNumber String?
  ifscCode      String?
  panNumber     String?
  aadhaarNumber String?

  departmentId    String?
  positionId      String?
  shiftId         String?
  salary          Decimal? @db.Decimal(12, 2) // CTC or Gross
  hourlyRate      Decimal? @db.Decimal(10, 2)
  salaryStructure Json? // { basic: 50%, hra: 40%, ... }

  // Employment Details
  employmentType String? // Full Time, Part Time, Contract, Internship, Trainee
  skills         Json? // ["React", "Node"]
  slackMemberId  String?

  // Probation & Notice
  probationEndDate      DateTime?
  noticePeriodStartDate DateTime?
  noticePeriodEndDate   DateTime?

  status             String   @default("active") // active, inactive, terminated, on-leave
  probationProcessed Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  company                Company                  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user                   User?                    @relation(fields: [userId], references: [id])
  creator                User?                    @relation("EmployeeCreator", fields: [createdById], references: [id])
  createdById            String?
  department             Department?              @relation(fields: [departmentId], references: [id])
  position               Position?                @relation(fields: [positionId], references: [id])
  shift                  Shift?                   @relation(fields: [shiftId], references: [id])
  documents              Document[] // Documents uploaded by/for this employee
  timesheets             Timesheet[]
  attendances            Attendance[]
  leaveRequests          LeaveRequest[]
  leaveBalances          EmployeeLeaveBalance[]
  leaveAccruals          LeaveAccrual[]
  payrolls               Payroll[]
  assets                 Asset[]
  salesTargets           SalesTarget[]
  salaryStructureDetails EmployeeSalaryStructure?
  shiftRosters           ShiftRoster[]
  projectMemberships     ProjectMember[]
  activeTimer            ActiveTimer?

  @@unique([companyId, employeeId])
  @@index([companyId])
  @@index([email])
  @@index([status])
}

// (Document model definition moved to existing locations below)

// ============================================
// ATTENDANCE & LEAVE
// ============================================

model Attendance {
  id         String    @id @default(uuid())
  employeeId String
  date       DateTime  @db.Date
  checkIn    DateTime?
  checkOut   DateTime?
  status     String    @default("present") // present, absent, half-day, leave
  ipAddress  String?
  location   String? // Lat,Long
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Allow multiple sessions per day
  @@index([employeeId, date])
  @@index([employeeId])
  @@index([date])
}

model LeaveType {
  id          String   @id @default(uuid())
  name        String   @unique
  days        Int      @default(0) // Default annual quota
  isPaid      Boolean  @default(true)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  leaveRequests LeaveRequest[]
  balances      EmployeeLeaveBalance[]
  accruals      LeaveAccrual[]

  frequency       String  @default("yearly") // yearly, monthly
  carryForward    Boolean @default(true)
  maxCarryForward Int     @default(0) // Max days that can be carried forward
  monthlyLimit    Int     @default(0) // 0 means no monthly limit

  // Accrual Settings
  accrualType       String @default("yearly") // yearly, monthly, daily
  accrualRate       Float  @default(0) // e.g., 1.5 for monthly accrual
  accrualStartMonth Int    @default(1) // Month when accrual starts (1-12)
  maxAccrual        Float  @default(0) // Max days that can be accrued (0 = no limit)

  // Advanced Constraints
  maxConsecutiveDays Int     @default(0) // 0 means no limit
  minServiceDays     Int     @default(0) // Probation period interaction
  sandwichRule       Boolean @default(false) // If leave is taken on Fri & Mon, Sat/Sun count?
  encashable         Boolean @default(false)
  proofRequired      Boolean @default(false)

  // Dynamic Policy Storage (Stores timestamps, thresholds, specific rules)
  policySettings Json? // e.g. { "noticePeriod": 14, "minDaysForProof": 3, "includeHolidays": true }

  // UI

  // UI
  color String @default("#3B82F6") // Hex color for calendar

  // Enterprise Scoping
  departmentIds    String[] @default([]) // Empty = All Departments
  positionIds      String[] @default([]) // Empty = All Positions
  employmentStatus String[] @default([]) // Empty = All (Probation, Permanent)

  // Quarterly & Probation Management
  quarterlyLimit    Int   @default(0) // Max days per quarter (0 = no limit)
  probationQuota    Float @default(0) // Leave quota during probation (0 = not allowed)
  confirmationBonus Float @default(0) // Days added after probation confirmation

  @@index([name])
}

model EmployeeLeaveBalance {
  id          String @id @default(uuid())
  employeeId  String
  leaveTypeId String
  year        Int // e.g., 2024

  allocated   Float @default(0) // Initial + Encashment + Manual adjustments
  carriedOver Float @default(0) // From previous year
  used        Float @default(0) // Consumed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employee  Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType LeaveType @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, leaveTypeId, year])
  @@index([employeeId])
}

model LeaveAccrual {
  id           String   @id @default(uuid())
  employeeId   String
  leaveTypeId  String
  year         Int
  month        Int // 1-12
  accruedDays  Float // Days accrued this month
  totalAccrued Float // Cumulative for the year
  createdAt    DateTime @default(now())

  employee  Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType LeaveType @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, leaveTypeId, year, month])
  @@index([employeeId, year])
  @@index([leaveTypeId])
}

model Shift {
  id            String   @id @default(uuid())
  companyId     String
  name          String // General, Morning, Night
  startTime     String // "09:00"
  endTime       String // "18:00"
  breakDuration Int      @default(60) // in minutes
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  company   Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employees Employee[]
  rosters   ShiftRoster[]

  workDays Json? // ["monday", "tuesday", "wednesday", "thursday", "friday"]

  @@index([companyId])
}

model Asset {
  id           String    @id @default(uuid())
  companyId    String
  name         String
  type         String // Laptop, Phone, License, etc.
  serialNumber String?
  status       String    @default("Available") // Available, Assigned, Maintenance, Retired
  purchaseDate DateTime?
  price        Float?
  currency     String   @default("INR")

  // Assignment
  employeeId   String?
  assignedDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee Employee? @relation(fields: [employeeId], references: [id])

  @@unique([companyId, serialNumber])
  @@index([companyId])
  @@index([employeeId])
}

model LeaveRequest {
  id          String    @id @default(uuid())
  employeeId  String
  leaveTypeId String
  startDate   DateTime  @db.Date
  endDate     DateTime  @db.Date
  days        Float // Changed to Float to support half-days (0.5)
  reason      String?   @db.Text
  status      String    @default("pending") // pending, approved, rejected, cancelled
  approvedBy  String?
  approvedAt  DateTime?

  // Advanced Features
  durationType   String  @default("full") // full, multiple, first_half, second_half
  attachmentPath String? // Path to uploaded document
  assignedBy     String? // If admin assigns leave
  category       String? // Specific category (e.g., Sick, Casual) for generic Leave Types
  lopDays        Float   @default(0) // Days marked as Loss of Pay

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employee  Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType LeaveType @relation(fields: [leaveTypeId], references: [id])

  @@index([employeeId])
  @@index([status])
  @@index([startDate])
}

model Holiday {
  id        String   @id @default(uuid())
  name      String
  date      DateTime @db.Date
  type      String   @default("national") // national, regional, company
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date])
  @@index([date])
}

model ShiftRoster {
  id         String   @id @default(uuid())
  employeeId String
  shiftId    String
  date       DateTime @db.Date
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  shift    Shift    @relation(fields: [shiftId], references: [id])

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
}

// ============================================
// PAYROLL
// ============================================

model Payroll {
  id                  String    @id @default(uuid())
  employeeId          String
  month               Int // 1-12
  year                Int
  basicSalary         Decimal   @db.Decimal(12, 2)
  allowances          Decimal   @default(0) @db.Decimal(12, 2)
  deductions          Decimal   @default(0) @db.Decimal(12, 2)
  earningsBreakdown   Json? // { basic: 5000, hra: 2000, ... }
  deductionsBreakdown Json? // { pf: 500, tax: 200, ... }
  grossSalary         Decimal   @db.Decimal(12, 2)
  netSalary           Decimal   @db.Decimal(12, 2)
  status              String    @default("draft") // draft, processed, paid
  processedAt         DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([year, month])
}

model SalaryComponent {
  id              String   @id @default(uuid())
  companyId       String
  name            String // Basic, HRA, Travel Allowance, PF, Tax
  type            String // earning, deduction
  calculationType String // flat, percentage_basic
  defaultValue    Decimal  @default(0) @db.Decimal(12, 2)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  company            Company                   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employeeComponents EmployeeSalaryComponent[]

  @@index([companyId])
}

model EmployeeSalaryStructure {
  id            String   @id @default(uuid())
  employeeId    String   @unique
  netSalary     Decimal  @db.Decimal(12, 2) // Monthly Net
  ctc           Decimal  @db.Decimal(12, 2) // Annual CTC
  effectiveDate DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  employee   Employee                  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  components EmployeeSalaryComponent[]
}

model EmployeeSalaryComponent {
  id            String  @id @default(uuid())
  structureId   String
  componentId   String
  monthlyAmount Decimal @db.Decimal(12, 2)

  structure EmployeeSalaryStructure @relation(fields: [structureId], references: [id], onDelete: Cascade)
  component SalaryComponent         @relation(fields: [componentId], references: [id])

  @@unique([structureId, componentId])
}

// ============================================
// ACCOUNTING & FINANCE
// ============================================

model Account {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  type      String // asset, liability, equity, income, expense
  parentId  String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  transactions Transaction[]

  @@index([code])
  @@index([type])
}

model Transaction {
  id          String   @id @default(uuid())
  accountId   String
  date        DateTime @db.Date
  type        String // debit, credit
  amount      Decimal  @db.Decimal(12, 2)
  description String?  @db.Text
  reference   String? // Invoice ID, Payment ID, etc.
  createdAt   DateTime @default(now())

  // Relations
  account Account @relation(fields: [accountId], references: [id])

  @@index([accountId])
  @@index([date])
  @@index([reference])
}

// ============================================
// INVOICING & BILLING
// ============================================

model Invoice {
  id                String    @id @default(uuid())
  companyId         String
  clientId          String
  invoiceNumber     String    @unique
  invoiceDate       DateTime  @db.Date
  dueDate           DateTime  @db.Date
  status            String    @default("draft") // draft, sent, paid, overdue, cancelled
  type              String    @default("invoice") // invoice, quotation, proforma
  currency          String    @default("INR")
  terms             String?   @db.Text
  subtotal          Decimal   @db.Decimal(12, 2)
  tax               Decimal   @default(0) @db.Decimal(12, 2)
  discount          Decimal   @default(0) @db.Decimal(12, 2)
  total             Decimal   @db.Decimal(12, 2)
  paidAmount        Decimal   @default(0) @db.Decimal(12, 2)
  isRecurring       Boolean   @default(false)
  recurringInterval String? // daily, weekly, monthly, yearly
  nextOccurrence    DateTime?
  recurringId       String?
  notes             String?   @db.Text
  pdfPath           String?
  projectId         String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Recurring Invoice Fields
  recurringStartDate DateTime? @db.Date
  recurringEndDate   DateTime? @db.Date
  recurringNextRun   DateTime? @db.Date
  recurringStatus    String    @default("active") // active, paused, ended

  // Relations
  company   Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client    Client        @relation(fields: [clientId], references: [id])
  items     InvoiceItem[]
  payments  Payment[]
  documents Document[]
  project   Project?      @relation(fields: [projectId], references: [id])

  @@unique([companyId, invoiceNumber])
  @@index([companyId])
  @@index([clientId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([invoiceDate])
  @@index([type])
  @@index([projectId])
}

model InvoiceItem {
  id          String   @id @default(uuid())
  invoiceId   String
  description String
  hsnCode     String?
  quantity    Decimal  @db.Decimal(10, 2)
  unit        String?  // e.g. "Hours", "Days", "Box"
  rate        Decimal  @db.Decimal(12, 2)
  taxRate     Decimal  @default(0) @db.Decimal(5, 2) // Percentage Snapshot
  taxRateId   String?  // Relation to TaxRate configuration
  amount      Decimal  @db.Decimal(12, 2)
  createdAt   DateTime @default(now())

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  taxRateConfig TaxRate? @relation(fields: [taxRateId], references: [id])

  appliedTaxes InvoiceItemTax[]

  @@index([invoiceId])
  @@index([taxRateId])
}

model TaxRate {
  id          String   @id @default(uuid())
  companyId   String
  name        String   // e.g. "GST 18%", "VAT 5%"
  percentage  Decimal  @db.Decimal(5, 2)
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  invoiceItems InvoiceItem[]
  quotationItems QuotationItem[]

  invoiceItemTaxes   InvoiceItemTax[]
  quotationItemTaxes QuotationItemTax[]

  @@index([companyId])
}

model InvoiceItemTax {
  id            String   @id @default(uuid())
  invoiceItemId String
  taxRateId     String
  name          String // Snapshot
  percentage    Decimal  @db.Decimal(5, 2) // Snapshot
  amount        Decimal  @db.Decimal(12, 2) // Calculated portion

  invoiceItem InvoiceItem @relation(fields: [invoiceItemId], references: [id], onDelete: Cascade)
  taxRate     TaxRate     @relation(fields: [taxRateId], references: [id])

  @@index([invoiceItemId])
  @@index([taxRateId])
}

model QuotationItemTax {
  id              String   @id @default(uuid())
  quotationItemId String
  taxRateId       String
  name            String // Snapshot
  percentage      Decimal  @db.Decimal(5, 2) // Snapshot
  amount          Decimal  @db.Decimal(12, 2) // Calculated portion

  quotationItem QuotationItem @relation(fields: [quotationItemId], references: [id], onDelete: Cascade)
  taxRate       TaxRate       @relation(fields: [taxRateId], references: [id])

  @@index([quotationItemId])
  @@index([taxRateId])
}

model UnitType {
  id          String   @id @default(uuid())
  companyId   String
  name        String   // e.g. "Kilogram", "Hours", "Box"
  symbol      String   // e.g. "kg", "hr", "box"
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model SalesTarget {
  id             String   @id @default(uuid())
  companyId      String
  employeeId     String
  period         String // e.g., "2024-Q1", "2024-01"
  startDate      DateTime @db.Date
  endDate        DateTime @db.Date
  targetAmount   Decimal  @db.Decimal(12, 2)
  achievedAmount Decimal  @default(0) @db.Decimal(12, 2)
  status         String   @default("active") // active, completed, expired
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([employeeId])
  @@index([period])
}

model Subscription {
  id              String    @id @default(uuid())
  companyId       String
  clientId        String
  name            String
  plan            String
  amount          Decimal   @db.Decimal(12, 2)
  currency        String    @default("INR")
  billingCycle    String    @default("monthly") // monthly, quarterly, yearly
  startDate       DateTime  @db.Date
  endDate         DateTime? @db.Date
  status          String    @default("active") // active, paused, cancelled, expired
  nextBillingDate DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client  Client  @relation(fields: [clientId], references: [id])

  @@index([companyId])
  @@index([clientId])
  @@index([status])
  @@index([nextBillingDate])
}

// ============================================
// PAYMENTS
// ============================================

model Payment {
  id             String   @id @default(uuid())
  invoiceId      String?
  amount         Decimal  @db.Decimal(12, 2)
  paymentDate    DateTime @db.Date
  paymentMethod  String // cash, bank-transfer, razorpay, cashfree, paypal
  gateway        String? // razorpay, cashfree, paypal
  transactionId  String?  @unique
  gatewayOrderId String?
  status         String   @default("pending") // pending, success, failed, refunded
  notes          String?  @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  invoice Invoice? @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
  @@index([transactionId])
  @@index([status])
  @@index([paymentDate])
}

// ============================================
// DOCUMENT MANAGEMENT
// ============================================

model Document {
  id         String  @id @default(uuid())
  companyId  String?
  clientId   String?
  invoiceId  String?
  employeeId String?
  projectId  String?
  taskId     String?

  name       String
  type       String // invoice, agreement, offer-letter, appointment-letter, resume, id_proof
  category   String?
  filePath   String
  fileSize   Int?
  mimeType   String?
  version    Int      @default(1)
  isTemplate Boolean  @default(false)
  tags       String[] // Array of tags
  metadata   Json? // Additional metadata
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  company  Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client   Client?   @relation(fields: [clientId], references: [id])
  invoice  Invoice?  @relation(fields: [invoiceId], references: [id])
  employee Employee? @relation(fields: [employeeId], references: [id])
  project  Project?  @relation(fields: [projectId], references: [id])
  task     Task?     @relation(fields: [taskId], references: [id])

  @@index([companyId])
  @@index([clientId])
  @@index([employeeId])
  @@index([projectId])
  @@index([type])
  @@index([category])
}

// ============================================
// RECRUITMENT / ATS
// ============================================

model JobOpening {
  id           String   @id @default(uuid())
  companyId    String
  title        String
  department   String?
  position     String?
  description  String?  @db.Text
  requirements String?  @db.Text
  status       String   @default("open") // open, closed, on-hold
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  company    Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  candidates Candidate[]

  @@index([companyId])
  @@index([status])
}

model Candidate {
  id           String   @id @default(uuid())
  companyId    String
  jobOpeningId String?
  firstName    String
  lastName     String
  email        String
  phone        String?
  resumePath   String?
  status       String   @default("applied") // applied, screening, interview, offer, hired, rejected
  currentStage String? // For Kanban: 'Screening', 'Technical Round', 'HR Round', 'Offer'
  notes        String?  @db.Text
  rating       Float? // Average rating
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  company     Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  jobOpening  JobOpening?  @relation(fields: [jobOpeningId], references: [id])
  interviews  Interview[]
  offerLetter OfferLetter?

  @@index([companyId])
  @@index([jobOpeningId])
  @@index([status])
  @@index([email])
}

model Interview {
  id          String   @id @default(uuid())
  candidateId String
  round       Int
  type        String // technical, hr, final
  scheduledAt DateTime
  interviewer String?
  feedback    String?  @db.Text
  rating      Int? // 1-5
  status      String   @default("scheduled") // scheduled, completed, cancelled, no-show
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  candidate Candidate           @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  scorecard InterviewScorecard?

  @@index([candidateId])
  @@index([scheduledAt])
}

model InterviewScorecard {
  id             String   @id @default(uuid())
  interviewId    String   @unique
  technical      Int      @default(0) // 1-10
  communication  Int      @default(0) // 1-10
  problemSolving Int      @default(0) // 1-10
  cultureFit     Int      @default(0) // 1-10
  comments       String?  @db.Text
  submittedBy    String?
  createdAt      DateTime @default(now())

  interview Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)
}

model EmailTemplate {
  id        String   @id @default(uuid())
  companyId String
  name      String
  subject   String
  body      String   @db.Text
  type      String // offer, rejection, interview_invite
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([type])
}

model OfferLetter {
  id           String   @id @default(uuid())
  candidateId  String   @unique
  position     String
  department   String?
  salary       Decimal  @db.Decimal(12, 2)
  startDate    DateTime @db.Date
  status       String   @default("pending") // pending, sent, accepted, rejected
  documentPath String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@index([status])
}

// ============================================
// AUDIT & LOGGING
// ============================================

model AuditLog {
  id         String   @id @default(uuid())
  companyId  String?
  userId     String?
  action     String
  module     String
  entityType String?
  entityId   String?
  details    String?  @db.Text
  changes    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Relations
  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([userId])
  @@index([module])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// ============================================
// DOCUMENT ENGINE
// ============================================

model DocumentTemplate {
  id             String   @id @default(uuid())
  companyId      String
  name           String
  description    String?
  type           String // OfferLetter, Payslip, Contract, Invoice
  filePath       String // Path to .docx template
  letterheadMode String   @default("NONE") // NONE, FIRST_PAGE, ALL_PAGES
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([type])
}

// ============================================
// ACCOUNTING
// ============================================

model LedgerAccount {
  id        String   @id @default(uuid())
  companyId String
  code      String // e.g., "1001", "2000"
  name      String // "Cash", "Accounts Receivable"
  type      String // asset, liability, equity, income, expense, combined
  balance   Decimal  @default(0) @db.Decimal(15, 2)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company      Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  journalLines JournalEntryLine[]

  @@unique([companyId, code])
  @@index([companyId])
}

model JournalEntry {
  id          String   @id @default(uuid())
  companyId   String
  date        DateTime @db.Date
  reference   String? // Invoice #, Payroll Month
  description String?
  status      String   @default("draft") // draft, posted
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  lines   JournalEntryLine[]

  @@index([companyId])
  @@index([date])
}

model JournalEntryLine {
  id             String  @id @default(uuid())
  journalEntryId String
  accountId      String
  debit          Decimal @default(0) @db.Decimal(15, 2)
  credit         Decimal @default(0) @db.Decimal(15, 2)
  description    String?

  journalEntry JournalEntry  @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account      LedgerAccount @relation(fields: [accountId], references: [id])

  @@index([journalEntryId])
  @@index([accountId])
}

// ============================================
// CONTRACTS & AGREEMENTS
// ============================================

model Contract {
  id        String  @id @default(uuid())
  companyId String
  clientId  String
  projectId String?
  creatorId String // User who created the contract

  title   String
  content String @db.Text // HTML Content
  status  String @default("draft") // draft, sent, viewed, signed, expired, cancelled

  // Amounts & Type
  contractValue Decimal? @default(0) @db.Decimal(12, 2)
  currency      String   @default("INR")
  contractType  String?

  // Dates
  validFrom  DateTime? @db.Date
  validUntil DateTime? @db.Date
  sentAt     DateTime?
  signedAt   DateTime?

  // Signature Data - Client
  clientSignature String? @db.Text // Base64 or URL
  signerName      String?
  signerIp        String?
  
  // Signature Data - Company
  companySignature String? @db.Text
  companySignerId  String?
  companySignedAt  DateTime?

  // PDF
  pdfPath String?

  // Template
  templateId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company  Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client   Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  project  Project?          @relation(fields: [projectId], references: [id])
  creator  User              @relation("ContractCreator", fields: [creatorId], references: [id])
  template ContractTemplate? @relation(fields: [templateId], references: [id])

  // Analytics
  viewCount       Int       @default(0)
  lastViewedAt    DateTime?
  emailOpens      Int       @default(0)
  lastEmailOpenedAt DateTime?

  activities      ContractActivity[]

  @@index([companyId])
  @@index([clientId])
  @@index([projectId])
  @@index([status])
}

model ContractActivity {
  id          String   @id @default(uuid())
  contractId  String
  type        String   // VIEWED, DOWNLOADED, EMAIL_OPENED, LINK_CLICKED, STATUS_CHANGE
  
  // Detailed Tracking
  ipAddress   String?
  userAgent   String?
  location    String?
  deviceType  String?
  browser     String?
  os          String?
  
  // Metadata
  metadata    Json?
  createdAt   DateTime @default(now())
  
  contract    Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  
  @@index([contractId])
  @@index([type])
  @@index([createdAt])
}

model ContractTemplate {
  id          String  @id @default(uuid())
  companyId   String
  name        String
  description String?
  content     String  @db.Text // HTML Content with placeholders
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company   Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contracts Contract[]

  @@index([companyId])
}
